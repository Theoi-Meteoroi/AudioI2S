#pragma once

#define ARM_MATH_CM0PLUS
#include <arm_math.h>

/*
Circuit:
 * Arduino/Genuino Zero, MKRZero or MKR1000 board
 * ICS43432:
   * GND connected GND
   * 3.3V connected 3.3V (Zero) or VCC (MKR1000, MKRZero)
   * WS connected to pin 0 (Zero) or pin 3 (MKR1000, MKRZero)
   * CLK connected to pin 1 (Zero) or pin 2 (MKR1000, MKRZero)
   * SD connected to pin 9 (Zero) or pin A6 (MKR1000, MKRZero)
*/

//MICROPHONE PROPERTIES (INVENSENSE)

const int BIT_LENGTH = 24;
const int FULL_SCALE_DBSPL = 120; // FULL SCALE dBSPL (AOP = 116dB SPL)
const double FULL_SCALE_DBFS = 20*log10(pow(2,(BIT_LENGTH)));


  /*
  if (mic_type==0) { //INVENSENSE
  //MICROPHONE PROPERTIES
    SENSITIVITY = -26; //ICS43432 sensitivity in dBFS
    BIT_LENGTH = 24; // HIGH PRECISSION 24-bit WORD LENGTH
    REFERENCE = 94; // ICS43432 dBSPL reference for sensitivity
    FULL_SCALE_DBSPL = 120; // FULL SCALE dBSPL (AOP = 116dB SPL)
    FULL_SCALE_DBFS = 20*log10(pow(2,(BIT_LENGTH))); //FULL SCALE dBFS
    ZERO_REF = pow(10,((FULL_SCALE_DBFS-abs(SENSITIVITY))/20)); //0-reference for REFERENCE
  } else { //ADAFRUIT
  //MICROPHONE PROPERTIES
    SENSITIVITY = -26; //ICS43432 sensitivity in dBFS
    BIT_LENGTH = 18; // HIGH PRECISSION 24-bit WORD LENGTH
    REFERENCE = 94; // ICS43432 dBSPL reference for sensitivity
    FULL_SCALE_DBSPL = 120; // FULL SCALE dBSPL (AOP = 116dB SPL)
    FULL_SCALE_DBFS = 20*log10(pow(2,(BIT_LENGTH))); //FULL SCALE dBFS
    ZERO_REF = pow(10,((FULL_SCALE_DBFS-abs(SENSITIVITY))/20)); //0-reference for REFERENCE
  }
  */


//WEIGHTING TABLES

//Table for 44100Hz and 256bins

  //#define WEIGHTINGTA_44100Hz_256_dB {-100,-21.2844260310722,-12.4228724856633,-8.37011556178957,-5.9139881969301,-4.24383542311708,-3.04044346349936,-2.14298944933934,-1.45780447705139,-0.925349137047911,-0.505652065631272,-0.170888118073134,0.0988211230923082,0.317963847625247,0.497275161521177,0.644823582398527,0.766751260599533,0.867788661120393,0.951618452320622,1.02113649816986,1.07864145331641,1.12597410254146,1.16462087326736,1.19579151006888,1.22047791454657,1.23949911743126,1.2535359431136,1.26315794401284,1.26884448830702,1.27100138976892,1.26997411235529,1.26605832363449,1.25950838180786,1.25054420132531,1.23935683813769,1.2261130577255,1.21095909025188,1.19402373251619,1.17542092222089,1.15525188377252,1.13360692448241,1.11056694418217,1.08620470885785,1.06058592913651,1.03377017672836,1.00581166578031,0.976759921185729,0.946660351953195,0.91555474455924,0.883481688637347,0.850476945264006,0.816573766395629,0.781803172611769,0.746194195169947,0.7097740874286,0.672568509908601,0.634601692610987,0.59589657766419,0.556474944919076,0.51635752272825,0.475564085825219,0.434113541948003,0.392024008622864,0.349312881329341,0.30599689410269,0.262092173488879,0.217614286646973,0.17257828429055,0.126998739071284,0.0808897799316282,0.0342651228878237,-0.0128619013524332,-0.0604783225823349,-0.10857150878596,-0.15712914605039,-0.206139220457,-0.255590001737062,-0.305470028501532,-0.355768094876553,-0.406473238395053,-0.457574729011694,-0.509062059122873,-0.560924934486575,-0.613153265948329,-0.665737161889398,-0.718666921322616,-0.771933027568915,-0.825526142454815,-0.879437100977358,-0.933656906388513,-0.988176725656126,-1.04298788526282,-1.09808186730832,-1.15345030588413,-1.20908498369268,-1.26497782888597,-1.32112091210116,-1.37750644367294,-1.43412677100452,-1.4909743760809,-1.54804187310989,-1.60532200627748,-1.66280764760604,-1.72049179490452,-1.77836756980119,-1.83642821585046,-1.89466709670602,-1.95307769435354,-2.01165360739672,-2.07038854939131,-2.12927634722211,-2.18831093951865,-2.24748637510567,-2.30679681148489,-2.36623651334507,-2.42579985109765,-2.48548129943548,-2.54527543591265,-2.60517693954354,-2.66518058941935,-2.72528126334088,-2.78547393646614,-2.84575367997191,-2.90611565972815,-2.96655513498468,-3.02706745706925,-3.08764806809663,-3.14829249968818,-3.20899637170155,-3.2697553909701,-3.33056535005206,-3.39142212598892,-3.45232167907324,-3.51326005162554,-3.57423336678044,-3.63523782728186,-3.69626971428742,-3.75732538618207,-3.81840127740088,-3.87949389726127,-3.94059982880469,-4.00171572764771,-4.06283832084292,-4.12396440574948,-4.18509084891364,-4.24621458495923,-4.30733261548833,-4.36844200799217,-4.42953989477247,-4.49062347187325,-4.5516899980233,-4.61273679358941,-4.67376123954039,-4.73476077642215,-4.79573290334372,-4.8566751769745,-4.91758521055269,-4.97846067290506,-5.03929928747804,-5.10009883138031,-5.16085713443682,-5.2215720782544,-5.28224159529888,-5.34286366798389,-5.40343632777125,-5.46395765428302,-5.52442577442521,-5.58483886152316,-5.64519513446858,-5.70549285687823,-5.76573033626428,-5.82590592321621,-5.88601801059437,-5.94606503273505,-6.00604546466702,-6.06595782133966,-6.12580065686237,-6.1855725637554,-6.24527217221198,-6.30489814937166,-6.36444919860484,-6.42392405880834,-6.48332150371206,-6.54264034119647,-6.60187941262108,-6.66103759216349,-6.72011378616928,-6.77910693251234,-6.83801599996581,-6.89683998758324,-6.95557792409014,-7.0142288672857,-7.0727919034545,-7.13126614678824,-7.18965073881734,-7.24794484785218,-7.30614766843413,-7.36425842079592,-7.42227635033155,-7.48020072707542,-7.53803084519066,-7.59576602246646,-7.65340559982444,-7.71094894083378,-7.76839543123503,-7.82574447847254,-7.88299551123543,-7.94014797900675,-7.99720135162104,-8.05415511882988,-8.11100878987556,-8.16776189307251,-8.22441397539657,-8.28096460208194,-8.33741335622556,-8.39375983839903,-8.45000366626772,-8.5061444742172,-8.56218191298663,-8.6181156493092,-8.67394536555937,-8.7296707594069,-8.78529154347751,-8.84080744502005,-8.89621820558009,-8.95152358067985,-9.0067233395043,-9.06181726459345,-9.1168051515405,-9.17168680869603,-9.22646205687792,-9.28113072908696,-9.3356926702281,-9.39014773683719,-9.44449579681307,-9.4987367291551,-9.55287042370577,-9.6068967808985,-9.66081571151052,-9.71462713642056,-9.76833098637155,-9.82192720173798,-9.87541573229797,-9.92879653700995,-9.98206958379384,-10.0352348493167,-10.0882923187824,-10.1412419857266,-10.194083851814,-10.246817926642,-10.2994442275465,-10.3519627794126,-10.4043736144894,-10.4566767722073,-10.5088722990009,-10.560960248134,-10.6129406795291}
  #define WEIGHTINGTA_44100Hz_256 {0,0.0862538915555343,0.239252440067295,0.381499718566378,0.506174881840981,0.613491046469462,0.704657091342527,0.781358835632495,0.845492532387227,0.898943803532723,0.943446758613464,0.980518052821849,1.011442168756,1.03728522618051,1.05892148026641,1.07706317893995,1.09228900743996,1.10506909425038,1.11578603774419,1.12475213161783,1.13222326008119,1.13841000815891,1.14348650518794,1.14759745249792,1.15086370996276,1.15338674443019,1.15525218115916,1.15653264835139,1.15729006385055,1.15757748064798,1.15744058242197,1.15691890053426,1.15604680851176,1.15485433808098,1.15336785152296,1.15161059787385,1.14960317484241,1.14736391388858,1.144909202431,1.14225375441076,1.13941083827188,1.13639246969807,1.13320957507457,1.12987213054712,1.12638928067012,1.12276943992611,1.1190203798254,1.11514930382876,1.11116291195666,1.10706745663856,1.10286879110129,1.09857241138616,1.09418349291168,1.08970692235556,1.08514732551056,1.08050909166977,1.07579639501394,1.0710132134039,1.06616334492279,1.0612504224636,1.05627792661571,1.05124919706901,1.04616744272406,1.04103575067143,1.03585709418121,1.03063433982534,1.02537025383928,1.02006750781565,1.0147286838109,1.00935627893557,1.00395270948995,0.998520314699319,0.99306136009617,0.987578040591138,0.982072483269213,0.976546749943447,0.971002839494508,0.965442690021033,0.959868180822797,0.954281134236092,0.948683317338438,0.943076443537719,0.937462174059082,0.931842119341346,0.92621784035331,0.920590849839106,0.914962613500672,0.909334551124467,0.903708037658683,0.898084404246482,0.892464939220101,0.886850889060089,0.881243459323409,0.875643815543675,0.870053084106385,0.864472353101651,0.858902673156583,0.853345058249221,0.847800486505647,0.842269900981679,0.836754210430351,0.83125429005623,0.825770982257424,0.820305097356057,0.814857414317805,0.809428681461038,0.804019617155993,0.79863091051432,0.793263222069304,0.787917184446967,0.782593403028247,0.777292456602357,0.772014898011446,0.766761254786601,0.761532029775251,0.756327701759963,0.751148726068651,0.745995535176175,0.740868539297297,0.735768126970984,0.730694665635993,0.725648502197718,0.720629963586252,0.715639357305606,0.710676971974081,0.705743077855713,0.700837927382786,0.695961755669379,0.691114781015906,0.686297205404659,0.681509214986311,0.676750980557397,0.672022658028753,0.667324388884942,0.662656300634656,0.658018507252134,0.653411109609613,0.648834195900849,0.644287842055744,0.639772112146134,0.635287058782778,0.63083272350362,0.626409137153377,0.622016320254532,0.617654283369795,0.613323027456127,0.609022544210399,0.60475281640678,0.600513818225947,0.596305515576211,0.592127866406669,0.587980821012465,0.583864322332297,0.579778306238247,0.575722701818072,0.571697431650051,0.567702412070528,0.563737553434233,0.559802760367541,0.555897932014755,0.552022962277563,0.54817774004777,0.544362149433441,0.540576069978573,0.536819376876427,0.533091941176635,0.529393629986214,0.52572430666461,0.522083831012889,0.518472059457211,0.5148888452267,0.511334038525829,0.507807486701459,0.504309034404633,0.500838523747253,0.497395794453758,0.493980684007924,0.490593027794891,0.487232659238545,0.483899409934353,0.480593109777784,0.477313587088399,0.474060668729743,0.470834180225132,0.467633945869448,0.464459788837038,0.461311531285828,0.45818899445774,0.455091998775533,0.45202036393613,0.448973909000568,0.445952452480626,0.442955812422246,0.439983806485832,0.437036252023507,0.434112966153428,0.431213765831224,0.428338467918663,0.42548688924961,0.422658846693364,0.419854157215444,0.417072637935918,0.41431410618532,0.411578379558249,0.408865275964721,0.406174613679325,0.403506211388266,0.400859888234358,0.398235463860026,0.395632758448378,0.39305159276242,0.390491788182462,0.387953166741769,0.385435551160528,0.382938764878175,0.380462632084138,0.378006977747047,0.375571627642463,0.373156408379176,0.370761147424114,0.368385673125924,0.366029814737245,0.363693402435748,0.36137626734396,0.359078241547929,0.356799158114758,0.354538851109067,0.352297155608395,0.350073907717599,0.347868944582282,0.345682104401278,0.343513226438233,0.341362151032316,0.339228719608089,0.337112774684568,0.335014159883506,0.332932719936925,0.330868300693929,0.32882074912682,0.326789913336546,0.324775642557513,0.322777787161772,0.32079619866262,0.318830729717626,0.316881234131118,0.314947566856136,0.313029583995888,0.31112714280472,0.309240101688628,0.307368320205317,0.305511659063845,0.303669980123854,0.301843146394414,0.30003102203249,0.298233472341061,0.29645036376689,0.294681563897973}

const double weightingtab[] = WEIGHTINGTA_44100Hz_256;

//DEBUGING
const int PRIORITY = 5; //_prio_fac = 1, 2, 3, 4 --> PRIO_FAC eliminates levels
//#define PRIORITY 5
//#define Serial SerialUSB